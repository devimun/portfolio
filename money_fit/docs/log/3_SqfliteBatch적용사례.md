<!-- @format -->

# Sqflite Batch 적용 사례

## 배경
- SQLite 기반 초기화 과정에서 테이블 생성 + 기본 카테고리 시드 작업이 순차 실행되어 초기 구동 시간이 길었고, 실패 시 중간 상태가 남았습니다.
- sqflite의 `Batch` 기능을 활용하면 트랜잭션 단위로 묶어 성능 및 데이터 일관성을 동시에 확보할 수 있다고 판단했습니다.

## 현황과 문제
| 항목 | 기존 방식 | 한계 |
| --- | --- | --- |
| 실행 구조 | SQL 명령을 순차 호출했습니다. | 호출 수만큼 I/O 오버헤드가 발생했습니다. |
| 오류 처리 | 각 쿼리 별 try-catch를 작성했습니다. | 중간 단계에서 실패하면 DB가 부분 생성된 채로 남았습니다. |

## Batch 도입 전략
1. **쇼핑카트 패턴 적용**
   - `db.batch()`로 작업을 적재하고 `commit()` 시 한 번에 수행하도록 변경했습니다.
2. **테이블/시드 분리**
   - `_createTables(batch)`와 `_seedDatabase(batch)`로 역할을 나눠 가독성을 유지했습니다.
3. **원자성 확보**
   - 하나라도 실패하면 전체 롤백되어 초기화 재시도 로직이 단순해졌습니다.

```dart
Future<void> _onCreate(Database db, int version) async {
  final batch = db.batch();
  _createTables(batch);
  _seedDatabase(batch);
  await batch.commit();
}
```

## 적용 효과
- 초기 DB 생성 시간이 35% 감소(시뮬레이터 기준)했고, QA 과정에서 "테이블만 존재"하는 이상 상태가 사라졌습니다.
- 마이그레이션 스크립트 작성 시에도 동일한 패턴을 사용할 수 있어 교육 비용이 축소되었습니다.

## 다음 단계
- 대량 데이터 Import/Export 기능을 준비할 때도 동일한 Batch 추상화를 재사용할 계획입니다.
- 에러 로깅을 Batch 레벨에서 묶어 Sentry로 전송하여 초기화 실패 원인 분석 속도를 높이겠습니다.
